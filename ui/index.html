<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Display a map on a webpage</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.0/mapbox-gl.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet" type="text/css" />
    <link href="main.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.0/mapbox-gl.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="//unpkg.com/alpinejs" defer></script>
    <style>
        body { margin: 0; padding: 0; }
    </style>
</head>

<body>
<div id="settings" x-data="{mapBoxApiKey: '', polygonApiKey: '', symbol: '', sdata: {o: 0.0, c: 0.0, h: 0.0, l: 0.0, v: 0.0}}">

    <label class="block mb-2 text-xs font-bold tracking-wide uppercase text-grey-darker" for="mapBoxApiKeyInput">Mapbox API Key</label>
    <input x-model="mapBoxApiKey" class="block w-full px-4 py-3 mb-3 border rounded appearance-none bg-grey-lighter text-grey-darker border-red" required type="text" id="mapBoxApiKeyInput">
    <button class="btn btn-primary" x-on:click="setMapboxApiKey()">
        Set Mapbox API Key
    </button>

    <br>
    <br>

    <label class="block mb-2 text-xs font-bold tracking-wide uppercase text-grey-darker" for="polygonApiKey">Polygon API Key</label>
    <input x-model="polygonApiKey" class="block w-full px-4 py-3 mb-3 border rounded appearance-none bg-grey-lighter text-grey-darker border-red" required type="text" id="polygonApiKey">

    <label class="block mb-2 text-xs font-bold tracking-wide uppercase text-grey-darker" for="symbol">Symbol</label>
    <input x-model="symbol" class="block w-full px-4 py-3 mb-3 border rounded appearance-none bg-grey-lighter text-grey-darker border-red" required type="text" id="symbol">

    <button class="btn btn-primary" x-on:click="sdata = await $fetchjson('https://api.polygon.io/v2/aggs/ticker/'+symbol+'/prev?adjusted=true&apiKey='+polygonApiKey, jsonPath=['results', 0])">
        Get OHLC Data
    </button>

    <br>
    <br>
    <hr>
    <br>

    <div class="stats shadow">
        <div class="stat">
            <span class="stat-title" x-text="'Symbol: ' + symbol"></span>
            <span class="stat-value" x-text="sdata.o"></span>
            <span class="stat-value" x-text="sdata.c"></span>
            <span class="stat-value" x-text="sdata.h"></span>
            <span class="stat-value" x-text="sdata.l"></span>
            <span class="stat-desc" x-text="'Volume: ' + sdata.v"></span>
        </div>

    </div>
</div>
<div id="map"></div>
<script>
    function setMapboxApiKey() {
        mapboxgl.accessToken = document.getElementById("mapBoxApiKeyInput").value;
        new mapboxgl.Map({
            container: 'map', // container ID
            style: 'mapbox://styles/mapbox/streets-v12', // style URL
            center: [-74.5, 40], // starting position [lng, lat]
            zoom: 9 // starting zoom
        });
    }

    document.addEventListener('alpine:init', async () => {
        Alpine.magic('fetchjson', () => {
            return async (url, jsonPath = [], method = "GET") => {
                let response = await xfetch(url = url, jsonPath = jsonPath, method = method)
                return await response;
            }
        })

        Alpine.magic('fetch', () => {
            return async (url, method = "GET") => {
                let response = await xfetch(url = url, jsonPath = null, method = method)
                return await response;
            }
        })
    })

    async function xfetch(url, jsonPath = [], method = 'GET') {
        if (jsonPath.length <= 0) {
            return fetch(url, {method: method})
                .then((response) => response.text())
                .then((responseText) => {
                    return responseText
                })
                .catch((error) => {
                    console.log(error)
                });
        } else {
            return fetch(url, {method: method})
                .then((response) => response.json())
                .then((responseJson) => {
                    let nextItem = responseJson
                    for (let i = 0; i < jsonPath.length; i++) {
                        nextItem = nextItem[jsonPath[i]];
                    }
                    return nextItem;
                })
                .catch((error) => {
                    console.log(error)
                });
        }
    }
</script>

</body>
</html>
